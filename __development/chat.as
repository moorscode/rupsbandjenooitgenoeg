package {	import flash.display.Sprite;	import flash.events.*;	import fl.events.ScrollEvent;		import flash.geom.Point;	import flash.net.URLLoader;	import flash.net.URLRequest;	import flash.text.TextField;	import flash.text.TextFormat;	import flash.utils.*;	import flash.ui.Keyboard;		import flash.external.ExternalInterface;	import flash.display.StageAlign;	import flash.display.StageScaleMode;		import fl.data.DataProvider;	import fl.events.ListEvent;	import fl.controls.DataGrid;	import fl.controls.dataGridClasses.DataGridColumn;	import fl.controls.ComboBox;	import fl.controls.listClasses.CellRenderer;	import fl.controls.UIScrollBar;	import fl.controls.TextArea;	import fl.controls.ScrollBarDirection;		import fl.containers.BaseScrollPane;		import com.moorscode.net.NetEvent;	import com.moorscode.net.NetController;		import com.moorscode.sound.*;		import com.moorscode.interfaces.ChatListRenderer;		public class chat extends Sprite {		private var initialized:Boolean = false;				private var myId:int = 0;		private var myName:String = '';		private var chatUsers:Array = new Array();		private var showUserIndex = -1;				private var lastColorLine:String = '';				private var previousWidth:Number = 0.0;				private var timeoutTimer:Timer;				// Event listeners for JS		protected var onConnected:String;		protected var onIdentified:String;		protected var onDisconnected:String;				// Consts for Chat coloring		private const NORMAL_TEXT:uint = 0;		private const STATUS_TEXT:uint = 1;		private const ERROR_TEXT:uint = 2;		private const JOIN_TEXT:uint = 3;		private const PART_TEXT:uint = 4;		private const NO_TIMESTAMP:uint = 5;		private const ACHIEVEMENT_TEXT:uint = 6;				public function chat():void {			// set custom renderer for tank icons:			chatList.setStyle("cellRenderer", ChatListRenderer);			chatList.addEventListener(ListEvent.ITEM_ROLL_OVER, showUsername);			chatList.addEventListener(MouseEvent.MOUSE_OUT, hideUsername);			chatList.addEventListener(MouseEvent.MOUSE_MOVE, positionUserPopup);						userPopup.addEventListener(MouseEvent.MOUSE_MOVE, hideUsername);													btnSend.addEventListener(MouseEvent.CLICK, sendText);						// fonts			var myFormat:TextFormat = new TextFormat();				myFormat.font = "Monaco";				myFormat.size = 9;				myFormat.color = 0x00000;						chatText.textField.antiAliasType = "advanced";			chatText.setStyle("textFormat", myFormat);			chatText.setStyle("embedFonts", true);			chatText.enabled = true;						chatInput.textField.antiAliasType = "advanced";			chatInput.setStyle("textFormat", myFormat);			chatInput.setStyle("embedFonts", true);						stage.scaleMode = StageScaleMode.NO_SCALE;			stage.align = StageAlign.TOP_LEFT;						Audio.path = "rupsbandjenooitgenoeg/chat/";						// preloader			addEventListener(Event.ENTER_FRAME, _frame);		}				// INITIALIZE - Wait for movieclip to be loaded completly		private function _frame(event:Event):void {			if(stage.loaderInfo.bytesTotal == stage.loaderInfo.bytesLoaded && !initialized) {				removeEventListener(event.type, arguments.callee);								initialize();								stage.addEventListener(Event.RESIZE, _resizeFields);			}		}				// INITIALIZE - After Preloading: Load Config		private function initialize():void {			if(initialized == true) return;			initialized = true;						_resizeFields();						ExternalInterface.addCallback("pushData", handleJSData);			ExternalInterface.addCallback("addEventListener", addJSEventListener);			ExternalInterface.addCallback("removeEventListener", removeJSEventListener);						JavaScript("flashLoaded", "chat");						var url:URLLoader = new URLLoader();				url.addEventListener(Event.COMPLETE, _parseServerXML);				url.load(new URLRequest("assets/servers.xml"));		}				protected function addJSEventListener(eventType:String, callback:String):Boolean {			switch(eventType) {				case "onConnected":				case "onIdentified":				case "onDisconnected":					this[eventType] = callback;					return true;					break;				default:					return false;					break;			}		}				protected function removeJSEventListener(eventType:String):void {			switch(eventType) {				case "onConnected":				case "onIdentified":				case "onDisconnected":					this[eventType] = null;					break;			}		}				// CONFIG - Read the data from the Config XML		private function _parseServerXML(event:Event):void {			var xml:XML = XML(event.target.data);			setListeners();			NetController.connect(String(xml.chatserver.server), int(xml.chatserver.port), false);						addToChatWindow('Bezig met verbinden.', STATUS_TEXT);		}				// GFX - add text to Chat Field		private function addToChatWindow(text:String, type:uint = NORMAL_TEXT):void {			if(!chatText.enabled) return;						var color:String;			switch(type) {				case STATUS_TEXT:					color = "000066";					break;				case ERROR_TEXT:					color = "990000";					break;				case JOIN_TEXT:					color = "006600";					break;				case PART_TEXT:					color = "606060";					break;				case ACHIEVEMENT_TEXT:					color = "C17C39";					break;				default:					color =	"000000";					break;			}						var prefix:String = '';			if(type == NORMAL_TEXT) {				var now:Date = new Date();				color = (lastColorLine == '000000')?'4a5a6d':'000000';			} else {				prefix = '~ ';			}						var line:String = '<font color="#' + color + '">';				line += prefix + text;				line += '</font>';						lastColorLine = color;						chatText.htmlText = line + ((chatText.htmlText == '') ? '' : '\n') + chatText.htmlText;						/*			chatText.htmlText += line;			chatText.verticalScrollPosition = chatText.maxVerticalScrollPosition; // scroll down			*/		}				// !! Handle Data recieved from the Server !! //		private function parseData(event:NetEvent):void {			var xmlData:XML = event.xml;			var what:String;			var username:String;						if(xmlData.t == "chat") {				switch(String(xmlData.w)) {					case "identified":						if(int(xmlData.success) == 0) {							addToChatWindow("Identificeren mislukt.", ERROR_TEXT);							addToChatWindow("Log in om deel te nemen aan de chat!");						} else {							myName = String(xmlData.n);							myId = int(xmlData.i);							enableChat();														addToChatWindow("Geïdentificeerd!", JOIN_TEXT);														if(onIdentified) {								JavaScript(onIdentified);							}						}												if(timeoutTimer) {							if(timeoutTimer.running) {								timeoutTimer.stop();							}														timeoutTimer = null;						}												break;										case "list":						// recieved the complete Chat List						for each(var user:XML in xmlData.us.u) {							addUserToList(user.i, user.n);						}												break;										case "part":						// somebody left the chat												// show notification						username = getChatUsername(uint(xmlData.i));						addToChatWindow(username + ' heeft zich afgemeld.', PART_TEXT);												// clean up the ChatUsernames array						removeChatUser(uint(xmlData.i));						break;										case "join":						// somebody joined						Audio.playSound("join.mp3", 0.8);												// show notification						addToChatWindow(xmlData.n + ' heeft zich aangemeld.', JOIN_TEXT);												// add to the user lists						addUserToList(uint(xmlData.i), xmlData.n);						break;										case "say":						// somebody said something						username = getChatUsername(uint(xmlData.i));						var line:String = xmlData.text;												if(xmlData.i != myId) {							if(line.toUpperCase().indexOf(myName.toUpperCase()) > -1) {								Audio.playSound("name.mp3");																var myPattern:RegExp = new RegExp(myName, "gi");								line = line.replace(myPattern, '<font color="#6f0000">'+myName+'</font>');							} else {								Audio.playSound("line.mp3", 0.5);							}						}												addToChatWindow(username + ': ' + line);						break;										case "achievement":						username = getChatUsername(uint(xmlData.i));						addToChatWindow('<font color="#7e4309">' + username + '</font> heeft <font color="#000000">\'' + xmlData.title + '\'</font> gehaald op ' + xmlData.when + '!', ACHIEVEMENT_TEXT);						break;				}			}		}				private function addUserToList(id:uint, name:String):void {			var found:Boolean = false;			for(var u:uint = 0; u < chatUsers.length; u++) {				if(chatUsers[u][0] == id) {					if(chatUsers[u][1] != name) {						chatUsers[u][1] = name;					}					found = true;				}			}						if(found) {				for(var i:uint = 0; i < chatList.length; i++) {					if(chatList.getItemAt(i).data == id) {						if(chatList.getItemAt(i).source != "assets/php/image.php?uid="+id) {							chatList.getItemAt(i).source = "assets/php/image.php?uid="+id;						}					}				}			} else {				chatUsers.push(new Array(id, name));				chatList.addItem({label:"", data:id, source:"assets/php/image.php?uid="+id});			}		}				// MISC - clean up chatusers list		private function removeChatUser(id:uint):void {			// remove ChatList item for the leaving player...			for(var itemIndex:uint = 0; itemIndex < chatList.length; itemIndex++) {				var item:Object = chatList.getItemAt(itemIndex);				if(item.data == id) {					chatList.removeItemAt(itemIndex);				}			}						// remove user from the list of users			for(var userIndex:uint = 0; userIndex < chatUsers.length; userIndex++) {				if(uint(chatUsers[userIndex][0]) == id) {					chatUsers.splice(userIndex, 1);					return;				}			}		}				private function showUsername(event:ListEvent):void {			var user = chatList.getItemAt(event.index);			var username:String = getChatUsername(user.data);						if(username != "") {				showUserIndex = event.index;								userPopup.username.htmlText = username;				userPopup.visible = true;			}		}				private function hideUsername(event:MouseEvent):void {			showUserIndex = -1;						positionUserPopup(event);		}				private function positionUserPopup(event:MouseEvent):void {			userPopup.x = Math.min( Math.max((userPopup.width / 2.0) + 5, event.stageX), stage.stageWidth - (userPopup.width / 2.0) - 5 );			userPopup.visible = (showUserIndex > -1);						if(userPopup.visible) {				var newPos:Number = userPopup.globalToLocal(new Point(event.stageX, event.stageY)).x - (userPopup.pointer.width / 2.0);				userPopup.pointer.x = Math.min( Math.max(-60,newPos), 38 );			}		}				private function handleJSData(data:String):Boolean {			if(!NetController.connected) return false;						if(data.substr(0, 3) == "ach") {				var achievementId:int = int(data.replace("ach", 0));								// handle achievements				var xml:XML = <a>								<w>achievement</w>								<i>{achievementId}</i>							  </a>;								NetController.send(xml);			}									return true;		}				// NET - request chat-users update		private function requestChatList():void {			var xml:XML = <a>							<t>chat</t>							<w>list</w>						  </a>;						NetController.send(xml);		}				// INTERFACE - handle chat text send request		private function sendText(event:*):void {			var doSend:Boolean = true;						if(event.type == KeyboardEvent.KEY_UP) {				doSend = (event.keyCode == Keyboard.ENTER);			}						if(doSend) {				var text:String = chatInput.text;				chatInput.text = '';								if(text != '') {					sendToChat(text);				}			}		}				// NET - send chat text to server		private function sendToChat(text:String):void {			var xml:XML = <a>							<t>chat</t>							<w>say</w>							<text>{text}</text>						  </a>;						NetController.send(xml);			chatInput.setFocus();		}				// MISC - UserId => Name		private function getChatUsername(id:uint):String {			for each(var user:Array in chatUsers) {				if(uint(user[0]) == id) {					return String(user[1]);				}			}			return "Onbekende gebruiker";		}				// NET - Handle events from the NetController:		private function netEvents(event:NetEvent):void {			switch(event.type) {				case NetEvent.CONNECT:					// request user_id					var phpSession:String = JavaScript("getVariable", "PHPSESSION");						phpSession = (phpSession == null)?"debug":phpSession;										NetController.push("PHPSESSION=" + phpSession);										addToChatWindow('Bezig met identificeren.', STATUS_TEXT);										timeoutTimer = new Timer(5000);					timeoutTimer.addEventListener(TimerEvent.TIMER, NetController.forceReconnect);					timeoutTimer.start();										if(onConnected) {						JavaScript(onConnected);					}										break;									case NetEvent.DISCONNECT:					chatList.removeAll();										myName = '';					myId = 0;										disableChat();					addToChatWindow('Serververbinding gesloten.', ERROR_TEXT);										if(onDisconnected) {						JavaScript(onDisconnected);					}					break;									case NetEvent.ERROR:					disableChat();					addToChatWindow('Er kan geen verbinding met de server gemaakt worden.', ERROR_TEXT);										if(onDisconnected) {						JavaScript(onDisconnected);					}					break;			}		}				// MISC - Leading Zero... should be in flash though?!		private function leadingZero(number:*):String {			return ((number < 10)?"0":"") + number;		}				private function _resizeFields(event:Event = null):void {			stage.focus = stage;						var width = stage.stageWidth;			var height = stage.stageHeight;						if(width == previousWidth) return;			previousWidth = width;						/* Firefox / IE Zoom functions actually resize the flash;			 * - Handle exact sizes.			 * ScaleMode: EXACT_FIT ?			 */						btnSend.width = (width < 300)?60:100;						chatList.width = width - 21;			chatText.width = width - 20;						chatText.width = width - 20;			chatText.y = chatList.y + chatList.height;						//chatInput.y = height - chatInput.height - 10;			chatInput.width = width - btnSend.width - 30;						btnSend.x = chatInput.width + 20;			btnSend.y = chatInput.y - 3;		}				// CHAT - enable chat interface		private function enableChat():void {						chatUsers = new Array();			chatList.removeAll();						btnSend.enabled = true;			chatList.enabled = true;			chatText.enabled = true;			chatInput.enabled = true;			chatInput.addEventListener(KeyboardEvent.KEY_UP, sendText);						chatInput.setFocus();		}				// CHAT - disable chat interface		private function disableChat() {			chatList.removeAll();						btnSend.enabled = false;			chatList.enabled = false;			chatInput.enabled = false;			chatInput.text = '';			chatInput.removeEventListener(KeyboardEvent.KEY_UP, sendText);		}						// NET - Set listeners for the NET Events		private function setListeners():void {			NetController.addEventListener(NetEvent.CONNECT, netEvents);			NetController.addEventListener(NetEvent.ERROR, netEvents);			NetController.addEventListener(NetEvent.DATA, parseData);			NetController.addEventListener(NetEvent.DISCONNECT, netEvents);		}				private function JavaScript(functionName:String, arguments:String = ""):String {			if(ExternalInterface.available) {				return ExternalInterface.call(functionName, arguments);			}						return null;		}	}}